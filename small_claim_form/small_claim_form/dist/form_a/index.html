
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Scanii</title>
    <!-- <title>European e-Justice Portal - Form A - Claim form</title> -->
    <base href="/" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" type="image/x-icon" href="favicon.ico" />
    <!-- <link rel="shortcut icon" type="image/x-icon" href="https://e-justice.europa.eu/assets/img/favicon.ico"> -->
    <script
      id="ppas_container_configuration"
      data-appid="f7c9a47b-a694-4597-9059-cbfb8b537954"
      data-host="webanalytics.europa.eu"
    ></script>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD"
      crossorigin="anonymous"
    />
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN"
      crossorigin="anonymous"
    ></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css"
    />
  </head>
  <body>
    <script>
      window.onload = function () {
        let model = null;
        let interaction = null;
        let actualStep = 1;
        main();
      };

      function showPdf(step) {
        divLegal = document.querySelectorAll("[scaii_pdf_step]");
        for (i = 0; i < divLegal.length; i++) {
          divLegal[i].style.display = "none";
        }

        // show pdf legal
        divLegal = document.querySelectorAll(
          '[scaii_pdf_step*="' + "step" + step + '"]'
        );
        divLegal.forEach((element) => {
          element.style.display = "initial";
        });

        document.activeElement.blur();
      }

      async function main() {
        //sessionStorage.clear();
        let modelRequest = await fetch("./small_claim_form/dist/form_a/content/json/model.json");
        model = await modelRequest.json();

        let interactionRequest = await fetch(
          "./small_claim_form/dist/form_a/content/json/interaction_it.json"
        );
        interaction = await interactionRequest.json();

        model.blocks.forEach((block) => {
          processBlock(block);
        });

        showPdf(1);
      }

      function showText(type) {
        divLegal = document.querySelectorAll("[simplyfied]");
        for (i = 0; i < divLegal.length; i++) {
          divLegal[i].style.display = "none";
        }
        divLegal = document.querySelectorAll("[original]");
        for (i = 0; i < divLegal.length; i++) {
          divLegal[i].style.display = "none";
        }
        divLegal = document.querySelectorAll("[" + type + "");
        for (i = 0; i < divLegal.length; i++) {
          divLegal[i].style.display = "block";
        }

        btn = document.getElementById("simplyfied_btn");
        if (type.includes("simplyfied")) {
          btn.setAttribute("onClick", 'showText("original")');
          btn.innerText = "Visualizza Testo originale";

          // change button icon
          ico = document.getElementById("simplyfied_ico");
          //ico.className = "bi bi-book-half";

          const toastLiveExample = document.getElementById("liveToast");
          const toast = new bootstrap.Toast(toastLiveExample);
          toast.show();

          // hide pdf legal
          simplificationBoxs = document.querySelectorAll(
            "[scanii_simplificationBox]"
          );
          for (i = 0; i < divLegal.length; i++) {
            simplificationBoxs[i].style =
              "margin-top: 20px; background-color: #F7FAA0 ; padding: 10px; border: 0px ";
            simplificationBoxs[i].title = "Testo semplificato";
          }
        } else {
          btn.setAttribute("onClick", 'showText("simplyfied")');
          btn.innerText = "Visualizza Testo Semplificato";
          // change button icon
          ico = document.getElementById("simplyfied_ico");
          //ico.className = "bi bi-book"

          simplificationBoxs = document.querySelectorAll(
            "[scanii_simplificationBox]"
          );
          for (i = 0; i < divLegal.length; i++) {
            simplificationBoxs[i].style =
              "margin-top: 20px; background-color: #cce6ff ; padding: 10px; border: 0px ";
            simplificationBoxs[i].title = "Testo originale";
          }
        }
      }

      function pdfShow(pdfId) {
        divLink = document.getElementById(pdfId);
        divLink.classList.add("pop-outin");
      }

      function pdfHide(pdfId) {
        divLink = document.getElementById(pdfId);
        divLink.classList.remove("pop-outin");
      }

      function processBlock(block) {
        console.log("processing block " + block.id);

        if (typeof block.concept != "undefined" && block.concept) {
          processConcept(block.id, block.concept);
        }

        if (typeof block.blocks != "undefined" && block.blocks) {
          block.blocks.forEach((subBlock) => {
            processBlock(subBlock);
          });
        }
      }

      function processLegalInfo(blockId, concept, infoElement) {
        divLegal = document.getElementById("legal_information");

        console.log("blockId=" + blockId);

        infoElement.link.forEach((link) => {
          if (
            typeof link !== "undefined" &&
            link !== null &&
            link.url !== "" &&
            link.type === "LEGAL_LINK"
          ) {
            let div = document.getElementById(link.url);

            if (typeof div != "undefined" && div !== null) {
              let attributeValue = div.getAttribute("scaii_pdf_step");
              div.setAttribute(
                "scaii_pdf_step",
                attributeValue + "," + blockId
              );
            } else {
              div = document.createElement("div");
              div.setAttribute("scaii_pdf_step", blockId);
              div.setAttribute("id", link.url);
              div.className = "list-item";
              a = document.createElement("a");
              a.href = link.url;
              a.setAttribute("target", "_blank");
              a.title = link.description;
              a.text = link.name;
              div.append(a);
              div.setAttribute("title", link.description);
              divLegal.append(div);
            }
          }
        });
      }

      function processConcept(blockId, concept) {
        console.log(" processing concept " + concept);
        if (concept.includes("ONE_OR_MANY")) {
          let length = concept.toString().length;
          length = length - 13;
          concept = concept.substr(12, length);
        }
        console.log(" find concept " + concept);

        let interactionElements = interaction.concepts.filter(
          (element) =>
            element.id == concept || element.id.includes(concept + ".")
        );
        if (typeof interactionElements != "undefined" && interactionElements) {
          interactionElements.forEach((interactionElement) => {
            interactionElement.infoElements.forEach((infoElement) => {
              processInfoElement(blockId, interactionElement.id, infoElement);
            });
          });
        }
      }

      function processInfoElement(blockId, concept, infoElement) {
        console.log(" processing infoElement " + infoElement.type);
        if (infoElement.type == "DESCRIPTION")
          processInfoElementDescription(concept, infoElement);

        processLegalInfo(blockId, concept, infoElement);

        if (infoElement.type == "INFORMATION")
          processInfoElementInformation(concept, infoElement);
      }

      function showSynonyms(synonyms) {
        let div = document.getElementById("synonyms_info");
        div.innerHTML = synonyms;
      }

      function hideSynonyms(synonyms) {
        let div = document.getElementById("synonyms_info");
        div.innerHTML = "";
      }

      function processInfoElementDescription(concept, infoElement) {
        elements = $('[concept="' + concept + '"]');
        let description = infoElement.text;

        // process description text start
        // process the words
        let list = [];
        let pos = 0;
        infoElement.words.forEach((word) => {
          keyPos = word.position.substr(0, word.position.indexOf("-"));
          keyLen = word.position.substr(word.position.indexOf("-") + 1);
          keyPos = keyPos - 1;
          key = description.substr(keyPos, keyLen);
          preKey = description.substr(pos, parseInt(keyPos) - parseInt(pos));

          pos = parseInt(keyPos) + parseInt(keyLen);
          list.push(document.createTextNode(preKey));
          keyTextNode = document.createTextNode(key);

          span = document.createElement("span");
          span.setAttribute("style", "background-color: #ccc;");
          text = word.definition;
          if (
            typeof word.synonyms != "undefined" &&
            word.synonyms &&
            word.synonyms.length > 0
          ) {
            text = text + " sinonimi: " + JSON.stringify(word.synonyms) + "";
            synms = "<ul>";
            for (let i = 0; i < word.synonyms.length; i++) {
              synms += "<li>" + word.synonyms[i] + "</li>";
            }
            synms += "</ul>";
            span.setAttribute("onmouseover", 'showSynonyms("' + synms + '")');
            span.setAttribute("onmouseout", 'hideSynonyms("' + synms + '")');
          }
          span.title = text;
          span.append(keyTextNode);

          list.push(span);
        });

        value = document.createTextNode(description.substr(pos));
        list.push(value);

        descriptionDiv = document.createElement("div");
        descriptionDiv.setAttribute("original", "");
        descriptionDiv.setAttribute("class", "description");
        list.forEach((tmp) => {
          descriptionDiv.append(tmp);
        });
        htmlFragment = descriptionDiv.innerHTML;

        // process links
        infoElement.link.forEach((link) => {
          if (typeof link.url != "undefined" && link.url && link.url != "") {
            replaceText = "";
            if (
              typeof link.description != "undefined" &&
              link.description &&
              link.description != ""
            )
              //replaceText = '<a target=”_blank” title="' + link.description + '" href="' + link.url + '" onmouseover="pdfShow(\''+link.url+'"\')">' + link.name + '</a>';
              replaceText =
                '<a  target=”_blank” href="' +
                link.url +
                '" onmouseout="pdfHide(\'' +
                link.url +
                "')\"" +
                '" onmouseover="pdfShow(\'' +
                link.url +
                "')\">" +
                link.name +
                "</a>";
            else
              replaceText =
                '<a  target=”_blank” href="' +
                link.url +
                '" onmouseout="pdfHide(\'' +
                link.url +
                "')\"" +
                '" onmouseover="pdfShow(\'' +
                link.url +
                "')\">" +
                link.name +
                "</a>";
            htmlFragment = htmlFragment.replaceAll(link.url, replaceText);
          }
          if (typeof link.text != "undefined" && link.text && link.text != "") {
            replaceText = "";
            if (
              typeof link.description != "undefined" &&
              link.description &&
              link.description != ""
            )
              //replaceText = '<a target=”_blank” title="' + link.description + '" href="' + link.url + '" onmouseover="pdfShow(\''+link.url+'"\')">' + link.name + '</a>';
              replaceText =
                '<a  target=”_blank” href="' +
                link.url +
                '" onmouseout="pdfHide(\'' +
                link.url +
                "')\"" +
                '" onmouseover="pdfShow(\'' +
                link.url +
                "')\">" +
                link.text +
                "</a>";
            else
              replaceText =
                '<a  target=”_blank” href="' +
                link.url +
                '" onmouseout="pdfHide(\'' +
                link.url +
                "')\"" +
                '" onmouseover="pdfShow(\'' +
                link.url +
                "')\">" +
                link.text +
                "</a>";
            htmlFragment = htmlFragment.replaceAll(link.text, replaceText);
          }
        });

        descriptionDiv.innerHTML = htmlFragment;
        // process description text end

        //add simplyfied text
        divSimp = document.createElement("div");
        divSimp.setAttribute("simplyfied", "");
        divSimp.innerText = infoElement.simplifiedText;
        divSimp.style.display = "none";

        // add simplification box
        simplificationBox = document.createElement("div");
        simplificationBox.style =
          "min-height: 1px;max-height: 3px;margin-top: 20px;background-color: #cce6ff ; padding: 10px; border: 0px";

        simplificationBox.title = "Testo originale";
        simplificationBox.setAttribute("scanii_simplificationBox", "");
        simplificationBox.setAttribute("class", "description");

        //separatore div
        separatorBox = document.createElement("span");
        separatorBox.style = "padding: 10px; ";

        // add yellow box start
        accordionDiv = document.createElement("div");
        accordionDiv.setAttribute("class", "accordion bs-success-rgb");
        accordionDiv.style =
          "background-color: #F9E79F ; padding: 10px; border: 1px solid green;";
        accordionItm = document.createElement("div");
        accordionItm.setAttribute("class", "accordion-item");
        accordionCnt = document.createElement("div");
        accordionCnt.setAttribute("id", concept);
        accordionCnt.setAttribute("class", "accordion-collapse collapse");
        accordionCnt.setAttribute("aria-labelledby", concept);

        yellowDiv = document.createElement("div");
        yellowDiv.setAttribute("class", "accordion-body");

        accordionCnt.append(yellowDiv);
        accordionCnt.style =
          "background-color: #F9E79F ; padding: 10px; border: 0px ";
        accordionBtn = document.createElement("button");
        accordionBtn.setAttribute("class", "accordion-button collapsed ");
        accordionBtn.setAttribute("type", "button");
        accordionBtn.setAttribute("data-bs-toggle", "collapse");
        accordionBtn.setAttribute("data-bs-target", "#" + concept);
        accordionBtn.setAttribute("aria-expanded", "true");
        accordionBtn.setAttribute("aria-controls", concept);
        accordionBtn.style =
          "background-color: #F9E79F; color: black; font-size:15px;";

        accordionBtn.innerText = "Dettagli";
        accordionItm.append(accordionBtn);
        accordionItm.append(accordionCnt);
        accordionDiv.append(accordionItm);
        accordionDiv.style = "background-color: #F9E79F ;";

        infoElement.link.forEach((link) => {
          if (link.type == "HOW_TO_LINK" || link.type == "DESCRITPION_LINK") {
            a = document.createElement("a");
            a.href = link.url;
            a.setAttribute("target", "_blank");
            //a.title = link.description;
            a.innerText = link.name;
            text = document.createElement("span");
            text.innerText = link.description;
            yellowDiv.append(a);
            yellowDiv.append(text);
            //yellowDiv.setAttribute('title', link.description);
            yellowDiv.append(document.createElement("br"));
          }
          if (link.type == "SERVICE_LINK") {
            if (
              typeof link.htmlFragment != "undefined" &&
              link.htmlFragment != ""
            ) {
              divTmp = document.createElement("div");
              divTmp.innerHTML = link.htmlFragment;
              text = document.createElement("span");
              text.innerText = link.description;
              yellowDiv.append(text);
              yellowDiv.append(divTmp);

              yellowDiv.append(document.createElement("br"));
            }
            if (typeof link.url != "undefined" && link.url != "") {
              a = document.createElement("a");
              a.href = link.url;
              a.setAttribute("target", "_blank");
              a.innerText = link.name;
              text = document.createElement("span");
              text.innerText = link.description;
              yellowDiv.append(a);
              yellowDiv.append(text);
              yellowDiv.append(document.createElement("br"));
            }
          }
        });
        // add yellow box end

        let divToAdd = document.createElement("div");
        divToAdd.append(descriptionDiv);
        divToAdd.append(divSimp);
        divToAdd.append(simplificationBox);
        divToAdd.append(separatorBox);
        if (yellowDiv.innerHTML != "") divToAdd.append(accordionDiv);

        for (let i = 0; i < elements.length; i++) {
          elements[i].insertBefore(divToAdd, elements[i].firstChild);
        }
      }

      function processInfoElementInformation(concept, infoElement) {
        elements = $('[concept="' + concept + '"]');
        for (let i = 0; i < elements.length; i++) {
          value = document.createTextNode("[i]");
          span = document.createElement("span");
          span.title = infoElement.text;
          span.append(value);
          elements[i].append(span);
        }
      }
    </script>
    <app-main></app-main>
  </body>
</html>
